import json
import socket
import sys
from os import path, system

sys.path.append('/tools')

from healthcheck_utils import base_url, check, get_login_header, get_manager_health_base, get_response, login_url

# Configuration
user = 'wazuh'
password = 'wazuh'
headers = get_login_header(user, password)
agents_to_check = ['001', '002']
healthcheck_state_file = '/tmp/healthcheck/healthcheck.state'


# Functions
def get_agents_node(status='active'):
    """Get to which manager each agent reports.

    Parameters
    ----------
    status : str
        Status to filter agents by.

    Returns
    -------
    dict, None
        Dictionary like {agent_id: manager_name} if agents were obtained, else None.
    """
    try:
        headers['Authorization'] = f'Bearer {get_response(login_url, headers)["data"]["token"]}'
        response = get_response(base_url + f'/agents?select=id,manager&status={status}',
                                headers)['data']['affected_items']
    except Exception:
        return

    return {item['id']: item['manager'] for item in response}


def get_healthcheck_state():
    with open(healthcheck_state_file, mode='r') as f:
        return json.loads(f.read())


def set_healthcheck_state(state):
    if state:
        with open(healthcheck_state_file, mode='w') as f:
            f.write(json.dumps(state, indent=4))


if __name__ == '__main__':
    # Get dict of agent IDs and the manager they report to.
    if not path.isfile(healthcheck_state_file):
        agents_node = get_agents_node()
        # If not all requested agents were returned, exit with error code
        if all(agent in agents_node.keys() for agent in agents_to_check):
            set_healthcheck_state(agents_node)
        else:
            exit(1)
    else:
        agents_node = get_healthcheck_state()

    checks_list = list()
    expected_log = "grep -q 'wazuh-modulesd:vulnerability-detector: INFO: (5471): Finished vulnerability assessment " \
                   "for agent '\\''{}'\\''' /var/ossec/logs/ossec.log"

    if socket.gethostname() == 'wazuh-master':
        checks_list.append(get_manager_health_base())

    for agent in agents_to_check:
        if agents_node[agent] == socket.gethostname():
            # Append only logs that are expected in the current node.
            checks_list.append(check(system(expected_log.format(agent))))

    exit(any(checks_list))
